{% extends "base.html" %}

{% block title %}Strength Analytics - Workout Tracker{% endblock %}

{% block content %}
<div class="strength-analytics">
    <header class="page-header">
        <a href="{{ url_for('analytics.index') }}" class="btn btn-secondary">Back</a>
        <h1>Strength Analytics</h1>
    </header>

    <!-- PRs Section -->
    <div class="card">
        <h2>Personal Records (1RM)</h2>
        {% if prs %}
        <ul class="pr-list">
            {% for pr in prs %}
            <li class="pr-item">
                <span class="pr-exercise">{{ pr.exercise.name if pr.exercise else 'Unknown' }}</span>
                <span class="pr-value">{{ pr.value }} kg</span>
                <span class="pr-date">{{ pr.date_achieved.strftime('%b %d, %Y') }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty-state-text">No PRs recorded yet. Keep lifting!</p>
        {% endif %}
    </div>

    <!-- Exercise Progress -->
    <div class="card">
        <h2>Exercise Progress</h2>
        {% if exercises %}
        <div class="form-group">
            <label for="exercise-select">Select Exercise</label>
            <select id="exercise-select">
                <option value="">Choose an exercise...</option>
                {% for exercise in exercises %}
                <option value="{{ exercise.exercise_id }}">{{ exercise.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="exercise-chart-container" class="chart-container" style="display:none;">
            <canvas id="exercise-chart"></canvas>
        </div>
        <div id="exercise-stats" class="mini-stats" style="display:none;"></div>
        {% else %}
        <p class="empty-state-text">No exercises logged yet.</p>
        {% endif %}
    </div>

    <!-- Volume by Muscle Group -->
    <div class="card">
        <h2>Volume by Muscle Group</h2>
        <div id="muscle-volume-container" class="chart-container-sm">
            <canvas id="muscle-chart"></canvas>
        </div>
        <div id="muscle-empty" class="empty-state-text" style="display:none;">
            No volume data yet.
        </div>
    </div>

    <!-- Weekly Volume Trend -->
    <div class="card">
        <h2>Weekly Volume Trend</h2>
        <div class="chart-container">
            <canvas id="volume-trend-chart"></canvas>
        </div>
    </div>

    <!-- PR History Graph -->
    <div class="card">
        <h2>PR History</h2>
        <p class="text-secondary text-sm">Track your personal record progression over time</p>
        {% if exercises %}
        <div class="form-group">
            <label for="pr-exercise-select">Select Exercise</label>
            <select id="pr-exercise-select">
                <option value="">Choose an exercise...</option>
                {% for exercise in exercises %}
                <option value="{{ exercise.exercise_id }}">{{ exercise.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div id="pr-chart-container" class="chart-container" style="display:none;">
            <canvas id="pr-history-chart"></canvas>
        </div>
        <div id="pr-milestones" class="pr-milestones" style="display:none;"></div>
        <div id="pr-empty" class="empty-state-text" style="display:none;">
            No PR data for this exercise yet.
        </div>
        {% else %}
        <p class="empty-state-text">No exercises logged yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js dark theme defaults
Chart.defaults.color = '#a0a0b0';
Chart.defaults.borderColor = '#2a2a40';

// Exercise progress chart
const exerciseSelect = document.getElementById('exercise-select');
const chartContainer = document.getElementById('exercise-chart-container');
const exerciseStats = document.getElementById('exercise-stats');
let exerciseChart = null;

if (exerciseSelect) {
    exerciseSelect.addEventListener('change', function() {
        const exerciseId = this.value;
        if (!exerciseId) {
            chartContainer.style.display = 'none';
            exerciseStats.style.display = 'none';
            return;
        }

        fetch(`{{ url_for('analytics.exercise_progress', exercise_id=0) }}`.replace('0', exerciseId))
            .then(r => r.json())
            .then(data => {
                if (data.length === 0) {
                    chartContainer.innerHTML = '<p class="empty-state-text">No data for this exercise.</p>';
                    chartContainer.style.display = 'block';
                    exerciseStats.style.display = 'none';
                    return;
                }

                chartContainer.innerHTML = '<canvas id="exercise-chart"></canvas>';
                chartContainer.style.display = 'block';

                if (exerciseChart) exerciseChart.destroy();

                exerciseChart = new Chart(document.getElementById('exercise-chart'), {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [
                            {
                                label: 'Est. 1RM (kg)',
                                data: data.map(d => d.estimated_1rm),
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Weight (kg)',
                                data: data.map(d => d.weight),
                                borderColor: '#22c55e',
                                borderDash: [5, 5],
                                tension: 0.3,
                                yAxisID: 'y'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    afterBody: function(context) {
                                        const idx = context[0].dataIndex;
                                        return `Reps: ${data[idx].reps}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: '#2a2a40' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });

                // Show stats
                const best1rm = Math.max(...data.map(d => d.estimated_1rm));
                const latest1rm = data[data.length - 1].estimated_1rm;
                const first1rm = data[0].estimated_1rm;
                const progress = ((latest1rm - first1rm) / first1rm * 100).toFixed(1);

                exerciseStats.innerHTML = `
                    <div class="mini-stat">
                        <span class="mini-stat-value">${best1rm.toFixed(1)}</span>
                        <span class="mini-stat-label">Best 1RM</span>
                    </div>
                    <div class="mini-stat">
                        <span class="mini-stat-value">${latest1rm.toFixed(1)}</span>
                        <span class="mini-stat-label">Latest 1RM</span>
                    </div>
                    <div class="mini-stat">
                        <span class="mini-stat-value ${progress >= 0 ? 'positive' : 'negative'}">${progress >= 0 ? '+' : ''}${progress}%</span>
                        <span class="mini-stat-label">Progress</span>
                    </div>
                `;
                exerciseStats.style.display = 'flex';
            });
    });
}

// Muscle group volume chart
fetch('{{ url_for("analytics.muscle_group_volume") }}')
    .then(r => r.json())
    .then(data => {
        if (data.length === 0) {
            document.getElementById('muscle-chart').style.display = 'none';
            document.getElementById('muscle-empty').style.display = 'block';
            return;
        }
        new Chart(document.getElementById('muscle-chart'), {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.muscle_group),
                datasets: [{
                    data: data.map(d => d.volume),
                    backgroundColor: [
                        '#6366f1', '#22c55e', '#f59e0b', '#ef4444',
                        '#8b5cf6', '#06b6d4', '#ec4899', '#84cc16'
                    ],
                    borderColor: '#1a1a2e',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { boxWidth: 12, padding: 15 }
                    }
                }
            }
        });
    });

// Weekly volume trend
fetch('{{ url_for("analytics.strength_volume_data") }}?weeks=8')
    .then(r => r.json())
    .then(data => {
        const weeks = Object.keys(data).sort();
        const muscleGroups = new Set();
        weeks.forEach(w => Object.keys(data[w]).forEach(mg => muscleGroups.add(mg)));

        const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
        const datasets = Array.from(muscleGroups).map((mg, i) => ({
            label: mg,
            data: weeks.map(w => data[w][mg] || 0),
            backgroundColor: colors[i % colors.length]
        }));

        new Chart(document.getElementById('volume-trend-chart'), {
            type: 'bar',
            data: {
                labels: weeks.map(w => w.slice(5)), // Just MM-DD
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    x: { stacked: true, grid: { display: false } },
                    y: { stacked: true, grid: { color: '#2a2a40' } }
                }
            }
        });
    });

// PR History chart
const prExerciseSelect = document.getElementById('pr-exercise-select');
const prChartContainer = document.getElementById('pr-chart-container');
const prMilestones = document.getElementById('pr-milestones');
const prEmpty = document.getElementById('pr-empty');
let prHistoryChart = null;

if (prExerciseSelect) {
    prExerciseSelect.addEventListener('change', function() {
        const exerciseId = this.value;
        if (!exerciseId) {
            prChartContainer.style.display = 'none';
            prMilestones.style.display = 'none';
            prEmpty.style.display = 'none';
            return;
        }

        fetch(`{{ url_for('analytics.pr_history', exercise_id=0) }}`.replace('0', exerciseId))
            .then(r => r.json())
            .then(data => {
                if (data.length === 0) {
                    prChartContainer.style.display = 'none';
                    prMilestones.style.display = 'none';
                    prEmpty.style.display = 'block';
                    return;
                }

                prEmpty.style.display = 'none';
                prChartContainer.innerHTML = '<canvas id="pr-history-chart"></canvas>';
                prChartContainer.style.display = 'block';

                if (prHistoryChart) prHistoryChart.destroy();

                // Find PR points for annotations
                const prPoints = data.filter(d => d.is_pr);

                prHistoryChart = new Chart(document.getElementById('pr-history-chart'), {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.date),
                        datasets: [{
                            label: 'Estimated 1RM (kg)',
                            data: data.map(d => d.estimated_1rm),
                            borderColor: '#6366f1',
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            tension: 0.3,
                            fill: true,
                            pointRadius: data.map(d => d.is_pr ? 8 : 3),
                            pointBackgroundColor: data.map(d => d.is_pr ? '#f59e0b' : '#6366f1'),
                            pointBorderColor: data.map(d => d.is_pr ? '#f59e0b' : '#6366f1'),
                            pointBorderWidth: data.map(d => d.is_pr ? 2 : 1)
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const idx = context.dataIndex;
                                        const d = data[idx];
                                        let label = `1RM: ${d.estimated_1rm} kg`;
                                        if (d.is_pr) label += ' (PR!)';
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        const idx = context.dataIndex;
                                        return `Max Weight: ${data[idx].max_weight} kg`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: { color: '#2a2a40' },
                                title: { display: true, text: 'Estimated 1RM (kg)' }
                            },
                            x: { grid: { display: false } }
                        }
                    }
                });

                // Show PR milestones
                if (prPoints.length > 0) {
                    const milestonesHtml = prPoints.slice(-5).reverse().map(pr => `
                        <div class="pr-milestone">
                            <span class="pr-milestone-icon">&#127942;</span>
                            <span class="pr-milestone-value">${pr.estimated_1rm} kg</span>
                            <span class="pr-milestone-date">${pr.date}</span>
                        </div>
                    `).join('');
                    prMilestones.innerHTML = `
                        <h4>Recent PRs</h4>
                        <div class="pr-milestone-list">${milestonesHtml}</div>
                    `;
                    prMilestones.style.display = 'block';
                } else {
                    prMilestones.style.display = 'none';
                }
            });
    });
}
</script>
{% endblock %}
