{% extends "base.html" %}

{% block title %}Log Exercise - Workout Tracker{% endblock %}

{% block content %}
<div class="workout-log">
    <header class="page-header">
        <h1>Strength Training</h1>
        <p class="session-date">{{ session.session_date }}</p>
    </header>

    <!-- Volume Spike Alerts -->
    {% if volume_spikes %}
    <div class="volume-spike-banner">
        <span class="spike-icon">&#9888;</span>
        <div class="spike-content">
            <div class="spike-title">Volume Spike Detected</div>
            <div class="spike-message">
                {% for spike in volume_spikes %}
                {{ spike.muscle_group }}: +{{ spike.increase_percent|round(1) }}% increase
                {% if not loop.last %}<br>{% endif %}
                {% endfor %}
            </div>
            <p class="spike-tip">Consider reducing volume to prevent overtraining.</p>
        </div>
    </div>
    {% endif %}

    <!-- Template Checklist (if using a template) -->
    {% if template_data %}
    <section class="card template-checklist">
        <div class="template-header-row">
            <h2>{{ template_data.name }}</h2>
            <span class="template-progress" id="templateProgress">0/{{ template_data.exercises|length }}</span>
        </div>
        <p class="text-secondary text-sm">Click an exercise to pre-fill the form</p>
        <ul class="template-exercise-checklist" id="templateChecklist">
            {% for ex in template_data.exercises %}
            <li class="template-checklist-item {% if ex.exercise_id in (current_logs|map(attribute='exercise_id')|list) %}completed{% endif %}"
                data-exercise-id="{{ ex.exercise_id }}"
                data-sets="{{ ex.last_sets }}"
                data-reps="{{ ex.last_reps }}"
                data-weight="{{ ex.last_weight or '' }}"
                data-name="{{ ex.exercise_name }}">
                <div class="checklist-checkbox">
                    {% if ex.exercise_id in (current_logs|map(attribute='exercise_id')|list) %}
                    &#10003;
                    {% else %}
                    {{ loop.index }}
                    {% endif %}
                </div>
                <div class="checklist-content">
                    <div class="checklist-exercise-name">{{ ex.exercise_name }}</div>
                    <div class="checklist-target">
                        Target: {{ ex.target_sets }}x{{ ex.target_reps }}
                        {% if ex.has_history %}
                        <span class="checklist-last">
                            | Last: {{ ex.last_sets }}x{{ ex.last_reps }}{% if ex.last_weight %} @ {{ ex.last_weight }}kg{% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="checklist-arrow">&#8250;</div>
            </li>
            {% endfor %}
        </ul>
    </section>
    {% endif %}

    <!-- Current Logs -->
    {% if current_logs %}
    <section class="card logged-exercises">
        <h2>Logged Sets</h2>
        <ul class="exercise-log-list">
            {% for log in current_logs %}
            <li class="logged-exercise">
                <div class="log-info">
                    <span class="log-exercise-name">{{ log.exercise.name }}</span>
                    <span class="log-details">{{ log.sets }}x{{ log.reps }} @ {{ log.weight_kg }}kg</span>
                    {% if log.rpe %}<span class="log-rpe">RPE {{ log.rpe }}</span>{% endif %}
                    <span class="log-1rm">Est. 1RM: {{ log.estimated_1rm }}kg</span>
                    {% if log.is_pr %}<span class="pr-badge">PR!</span>{% endif %}
                </div>
                <form method="POST" action="{{ url_for('workouts.delete_log', log_id=log.log_id) }}" class="delete-form">
                    <button type="submit" class="btn-icon btn-delete" title="Delete">&times;</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        <div class="session-summary">
            <span>Total Volume: {{ session.total_volume|int }}kg</span>
        </div>
    </section>
    {% endif %}

    <!-- Add Exercise Form -->
    <section class="card" id="addSetCard">
        <h2>Add Set</h2>
        <form method="POST" class="exercise-form" id="exerciseForm">
            <div class="form-group">
                <label for="exercise_id">Exercise</label>
                <select id="exercise_id" name="exercise_id" required class="exercise-select">
                    <option value="">Select exercise...</option>
                    {% for exercise in exercises %}
                    <option value="{{ exercise.exercise_id }}"
                            data-muscle="{{ exercise.muscle_group }}">
                        {{ exercise.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Substitute Button (shown when exercise selected) -->
            <div class="substitute-section" id="substituteSection" style="display: none;">
                <button type="button" class="btn btn-secondary btn-sm" id="showSubstitutes">
                    Machine busy? Show alternatives
                </button>
                <div id="substituteList" class="substitute-list" style="display: none;"></div>
            </div>

            <!-- Last Performance (shown when exercise selected) -->
            <div class="last-performance" id="lastPerformance" style="display: none;">
                <p>Last time: <span id="lastDetails"></span></p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="sets">Sets</label>
                    <input type="number" id="sets" name="sets" min="1" max="20"
                           required inputmode="numeric" class="input-large">
                </div>
                <div class="form-group">
                    <label for="reps">Reps</label>
                    <input type="number" id="reps" name="reps" min="1" max="100"
                           required inputmode="numeric" class="input-large">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="weight_kg">Weight (kg)</label>
                    <input type="number" id="weight_kg" name="weight_kg" min="0" max="500"
                           step="0.5" inputmode="decimal" class="input-large">
                </div>
                <div class="form-group">
                    <label for="rpe">RPE (1-10)</label>
                    <input type="number" id="rpe" name="rpe" min="1" max="10"
                           inputmode="numeric" class="input-large">
                </div>
            </div>

            <!-- Rest Timer Section -->
            <div class="form-group rest-timer-group">
                <label>Rest Timer</label>
                <div class="rest-timer-container" id="restTimerContainer">
                    <div class="timer-display" id="timerDisplay">1:30</div>
                    <div class="timer-controls">
                        <button type="button" class="btn btn-timer" id="timerStart" title="Start">
                            <span class="timer-icon">&#9658;</span>
                        </button>
                        <button type="button" class="btn btn-timer btn-stop" id="timerStop" style="display: none;" title="Stop">
                            <span class="timer-icon">&#9632;</span>
                        </button>
                        <button type="button" class="btn btn-timer-small" id="timerReset" title="Reset">
                            &#8635;
                        </button>
                    </div>
                    <div class="timer-presets">
                        <button type="button" class="timer-preset" data-seconds="60">1:00</button>
                        <button type="button" class="timer-preset" data-seconds="90">1:30</button>
                        <button type="button" class="timer-preset" data-seconds="120">2:00</button>
                        <button type="button" class="timer-preset" data-seconds="180">3:00</button>
                    </div>
                </div>
                <div class="rest-manual">
                    <label for="rest_seconds">Or enter manually (seconds)</label>
                    <input type="number" id="rest_seconds" name="rest_seconds"
                           min="0" max="600" inputmode="numeric" placeholder="Optional">
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block btn-large">
                Log Set
            </button>
        </form>
    </section>

    <!-- Finish Workout -->
    <section class="card">
        <h2>Finish Workout</h2>
        <form method="POST" action="{{ url_for('workouts.finish_session', session_id=session.session_id) }}">
            <div class="form-group">
                <label for="duration_minutes">Total Duration (minutes)</label>
                <input type="number" id="duration_minutes" name="duration_minutes"
                       value="{{ session.duration_minutes or '' }}" inputmode="numeric">
            </div>
            <div class="form-group">
                <label for="notes">Session Notes</label>
                <textarea id="notes" name="notes" rows="2">{{ session.notes or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-success btn-block">
                Complete Workout
            </button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const exerciseSelect = document.getElementById('exercise_id');

    // Auto-start timer if a set was just logged (check for success flash)
    {% if just_logged %}
    if (typeof restTimer !== 'undefined') {
        restTimer.autoStart();
    }
    {% endif %}

    const substituteSection = document.getElementById('substituteSection');
    const showSubstitutesBtn = document.getElementById('showSubstitutes');
    const substituteList = document.getElementById('substituteList');
    const lastPerformance = document.getElementById('lastPerformance');
    const lastDetails = document.getElementById('lastDetails');

    // Template checklist click handlers
    const checklist = document.getElementById('templateChecklist');
    if (checklist) {
        checklist.querySelectorAll('.template-checklist-item:not(.completed)').forEach(item => {
            item.addEventListener('click', function() {
                const exerciseId = this.dataset.exerciseId;
                const sets = this.dataset.sets;
                const reps = this.dataset.reps;
                const weight = this.dataset.weight;
                const name = this.dataset.name;

                // Select the exercise in dropdown
                exerciseSelect.value = exerciseId;

                // Pre-fill form with last performance
                document.getElementById('sets').value = sets;
                document.getElementById('reps').value = reps;
                document.getElementById('weight_kg').value = weight;

                // Show last performance
                if (weight) {
                    lastDetails.textContent = `${sets}x${reps} @ ${weight}kg`;
                    lastPerformance.style.display = 'block';
                }

                // Show substitute section
                substituteSection.style.display = 'block';
                substituteList.style.display = 'none';

                // Scroll to form
                document.getElementById('addSetCard').scrollIntoView({ behavior: 'smooth' });

                // Highlight selected item
                checklist.querySelectorAll('.template-checklist-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Update progress counter
        updateTemplateProgress();
    }

    function updateTemplateProgress() {
        const progressEl = document.getElementById('templateProgress');
        if (!progressEl || !checklist) return;

        const total = checklist.querySelectorAll('.template-checklist-item').length;
        const completed = checklist.querySelectorAll('.template-checklist-item.completed').length;
        progressEl.textContent = `${completed}/${total}`;

        if (completed === total && total > 0) {
            progressEl.classList.add('complete');
        }
    }

    // When exercise changes (manual selection)
    exerciseSelect.addEventListener('change', function() {
        const exerciseId = this.value;
        if (!exerciseId) {
            substituteSection.style.display = 'none';
            lastPerformance.style.display = 'none';
            return;
        }

        substituteSection.style.display = 'block';
        substituteList.style.display = 'none';

        // Check if this is from template (already pre-filled)
        if (checklist) {
            const templateItem = checklist.querySelector(`[data-exercise-id="${exerciseId}"]`);
            if (templateItem && templateItem.classList.contains('active')) {
                // Already handled by template click
                return;
            }
        }

        // Fetch last performance
        fetch(`/workouts/exercise/${exerciseId}/last-performance`)
            .then(r => r.json())
            .then(data => {
                if (data.found) {
                    lastDetails.textContent = `${data.sets}x${data.reps} @ ${data.weight_kg}kg (${data.date})`;
                    lastPerformance.style.display = 'block';

                    // Pre-fill form
                    document.getElementById('sets').value = data.sets;
                    document.getElementById('reps').value = data.reps;
                    document.getElementById('weight_kg').value = data.weight_kg || '';
                } else {
                    lastPerformance.style.display = 'none';
                }
            });
    });

    // Show substitutes
    showSubstitutesBtn.addEventListener('click', function() {
        const exerciseId = exerciseSelect.value;
        if (!exerciseId) return;

        fetch(`/workouts/exercise/${exerciseId}/substitutes`)
            .then(r => r.json())
            .then(data => {
                if (data.substitutes.length === 0) {
                    substituteList.innerHTML = '<p>No substitutes defined for this exercise.</p>';
                } else {
                    let html = '<ul class="substitute-options">';
                    data.substitutes.forEach(sub => {
                        const lastInfo = sub.last_weight_kg
                            ? `Last: ${sub.last_sets}x${sub.last_reps} @ ${sub.last_weight_kg}kg`
                            : 'No previous data';
                        html += `
                            <li class="substitute-option" data-id="${sub.substitute_exercise_id}">
                                <span class="sub-name">${sub.exercise_name}</span>
                                <span class="sub-last">${lastInfo}</span>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    substituteList.innerHTML = html;

                    // Add click handlers
                    substituteList.querySelectorAll('.substitute-option').forEach(opt => {
                        opt.addEventListener('click', function() {
                            const subId = this.dataset.id;
                            exerciseSelect.value = subId;
                            exerciseSelect.dispatchEvent(new Event('change'));
                            substituteList.style.display = 'none';
                        });
                    });
                }
                substituteList.style.display = 'block';
            });
    });
});
</script>
{% endblock %}
