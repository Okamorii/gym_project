{% extends "base.html" %}

{% block title %}{{ month_name }} {{ year }} - Workout Planner{% endblock %}

{% block content %}
<div class="planning-calendar">
    <header class="calendar-header">
        <div class="calendar-nav">
            <a href="{{ url_for('planning.index', year=prev_year, month=prev_month) }}" class="btn-nav">&larr;</a>
            <h1>{{ month_name }} {{ year }}</h1>
            <a href="{{ url_for('planning.index', year=next_year, month=next_month) }}" class="btn-nav">&rarr;</a>
        </div>
        {% if today.year != year or today.month != month %}
        <a href="{{ url_for('planning.index') }}" class="btn btn-sm btn-secondary">Today</a>
        {% endif %}
    </header>

    <!-- Completion Stats -->
    {% if stats.total > 0 %}
    <div class="completion-bar">
        <div class="completion-info">
            <span>{{ stats.completed }}/{{ stats.total }} completed</span>
            <span class="completion-pct {% if stats.rate >= 80 %}high{% elif stats.rate >= 50 %}medium{% else %}low{% endif %}">{{ stats.rate }}%</span>
        </div>
        <div class="completion-track">
            <div class="completion-fill" style="width: {{ stats.rate }}%"></div>
        </div>
    </div>
    {% endif %}

    <!-- Calendar Grid -->
    <div class="calendar-grid">
        <!-- Day Headers -->
        <div class="calendar-day-header">Mon</div>
        <div class="calendar-day-header">Tue</div>
        <div class="calendar-day-header">Wed</div>
        <div class="calendar-day-header">Thu</div>
        <div class="calendar-day-header">Fri</div>
        <div class="calendar-day-header">Sat</div>
        <div class="calendar-day-header">Sun</div>

        <!-- Calendar Days -->
        {% for week in calendar_weeks %}
        {% for day in week %}
        <div class="calendar-day {% if day.is_today %}today{% endif %} {% if not day.is_current_month %}other-month{% endif %} {% if day.is_past and not day.is_today %}past{% endif %}"
             data-date="{{ day.date.isoformat() }}">
            <div class="day-number">{{ day.day }}</div>

            <div class="day-events">
                <!-- Planned workouts -->
                {% for plan in day.plans %}
                <div class="event planned {{ plan.workout_type }} {% if plan.completed %}completed{% endif %}"
                     {% if plan.template_id %}data-template="{{ plan.template_id }}"{% endif %}>
                    <span class="event-icon">
                        {% if plan.workout_type == 'upper_body' %}&#128170;
                        {% elif plan.workout_type == 'running' %}&#127939;
                        {% else %}&#128164;{% endif %}
                    </span>
                    <span class="event-text">
                        {% if plan.template %}{{ plan.template.name }}
                        {% elif plan.description %}{{ plan.description }}
                        {% else %}{{ plan.workout_type|replace('_', ' ')|title }}{% endif %}
                    </span>
                    {% if plan.completed %}
                    <span class="event-check">&#10003;</span>
                    {% endif %}
                </div>
                {% endfor %}

                <!-- Actual workouts (unplanned) -->
                {% for workout in day.actual %}
                {% set has_plan = day.plans|selectattr('workout_type', 'equalto', workout.session_type)|list|length > 0 %}
                {% if not has_plan %}
                <div class="event actual {{ workout.session_type }}">
                    <span class="event-icon">
                        {% if workout.session_type == 'upper_body' %}&#128170;
                        {% elif workout.session_type == 'running' %}&#127939;
                        {% else %}&#127947;{% endif %}
                    </span>
                    <span class="event-text">Done</span>
                </div>
                {% endif %}
                {% endfor %}
            </div>

            <!-- Add button (only for current month, not past) -->
            {% if day.is_current_month and (not day.is_past or day.is_today) %}
            <button class="day-add-btn" onclick="openAddModal('{{ day.date.isoformat() }}')" title="Add workout">+</button>
            {% endif %}
        </div>
        {% endfor %}
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="calendar-legend">
        <div class="legend-item"><span class="dot upper_body"></span> Strength</div>
        <div class="legend-item"><span class="dot running"></span> Running</div>
        <div class="legend-item"><span class="dot rest"></span> Rest</div>
        <div class="legend-item"><span class="dot completed"></span> Completed</div>
    </div>
</div>

<!-- Add Workout Modal -->
<div class="modal" id="addModal" style="display: none;">
    <div class="modal-backdrop" onclick="closeAddModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Plan Workout</h3>
            <button class="modal-close" onclick="closeAddModal()">&times;</button>
        </div>
        <form method="POST" action="{{ url_for('planning.add_plan') }}" id="addPlanForm">
            <input type="hidden" name="planned_date" id="modalDate">

            <div class="form-group">
                <label>Date</label>
                <div class="modal-date-display" id="modalDateDisplay"></div>
            </div>

            <div class="form-group">
                <label for="workout_type">Workout Type</label>
                <select name="workout_type" id="workout_type" required onchange="toggleTemplateSelect()">
                    <option value="">Select type...</option>
                    <option value="upper_body">Strength Training</option>
                    <option value="running">Running</option>
                    <option value="rest">Rest Day</option>
                </select>
            </div>

            <!-- Template Selection (for strength) -->
            <div class="form-group" id="templateGroup" style="display: none;">
                <label for="template_id">Use Template (optional)</label>
                <select name="template_id" id="template_id">
                    <option value="">No template</option>
                    {% for template in templates %}
                    <option value="{{ template.template_id }}">{{ template.name }} ({{ template.exercises.count() }} exercises)</option>
                    {% endfor %}
                </select>
                <p class="form-hint">Template pre-fills your exercises with last weights</p>
            </div>

            <div class="form-group">
                <label for="description">Notes (optional)</label>
                <input type="text" name="description" id="description" placeholder="e.g., Push focus, Tempo run">
            </div>

            <!-- Running-specific fields -->
            <div class="form-group running-field" style="display: none;">
                <label for="target_distance">Target Distance (km)</label>
                <input type="text" name="target_distance" id="target_distance" inputmode="decimal" placeholder="e.g., 5 or 5,5">
            </div>

            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add to Plan</button>
            </div>
        </form>
    </div>
</div>

<!-- Day Detail Modal (for clicking existing events) -->
<div class="modal" id="dayModal" style="display: none;">
    <div class="modal-backdrop" onclick="closeDayModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="dayModalTitle">Day Details</h3>
            <button class="modal-close" onclick="closeDayModal()">&times;</button>
        </div>
        <div id="dayModalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function openAddModal(dateStr) {
    document.getElementById('modalDate').value = dateStr;
    const dateObj = new Date(dateStr);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('modalDateDisplay').textContent = dateObj.toLocaleDateString('en-US', options);
    document.getElementById('addModal').style.display = 'flex';
    document.getElementById('workout_type').value = '';
    document.getElementById('templateGroup').style.display = 'none';
    document.querySelectorAll('.running-field').forEach(el => el.style.display = 'none');
}

function closeAddModal() {
    document.getElementById('addModal').style.display = 'none';
}

function toggleTemplateSelect() {
    const type = document.getElementById('workout_type').value;
    const templateGroup = document.getElementById('templateGroup');
    const runningFields = document.querySelectorAll('.running-field');

    if (type === 'upper_body') {
        templateGroup.style.display = 'block';
        runningFields.forEach(el => el.style.display = 'none');
    } else if (type === 'running') {
        templateGroup.style.display = 'none';
        runningFields.forEach(el => el.style.display = 'block');
    } else {
        templateGroup.style.display = 'none';
        runningFields.forEach(el => el.style.display = 'none');
    }
}

function closeDayModal() {
    document.getElementById('dayModal').style.display = 'none';
}

// Click on calendar day to open add modal (but not on events)
document.querySelectorAll('.calendar-day').forEach(day => {
    day.addEventListener('click', function(e) {
        // Don't trigger if clicking on event or add button
        if (e.target.closest('.event') || e.target.closest('.day-add-btn')) return;

        const date = this.dataset.date;
        if (date && !this.classList.contains('past')) {
            openAddModal(date);
        }
    });
});

// Click on event to show details/actions
document.querySelectorAll('.event.planned').forEach(event => {
    event.addEventListener('click', function(e) {
        e.stopPropagation();
        const day = this.closest('.calendar-day');
        const date = day.dataset.date;
        const templateId = this.dataset.template;
        const text = this.querySelector('.event-text').textContent;
        const isCompleted = this.classList.contains('completed');
        const isStrength = this.classList.contains('upper_body');

        let html = `<div class="day-detail-event">`;
        html += `<h4>${text}</h4>`;
        html += `<p class="text-secondary">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}</p>`;

        if (!isCompleted) {
            if (isStrength && templateId) {
                html += `<a href="/workouts/new?template=${templateId}" class="btn btn-success btn-block">Start Workout</a>`;
            } else if (isStrength) {
                html += `<a href="/workouts/new" class="btn btn-success btn-block">Start Workout</a>`;
            } else if (this.classList.contains('running')) {
                html += `<a href="/running/new" class="btn btn-success btn-block">Log Run</a>`;
            }
        } else {
            html += `<p class="text-success">Completed!</p>`;
        }

        html += `</div>`;

        document.getElementById('dayModalTitle').textContent = text;
        document.getElementById('dayModalContent').innerHTML = html;
        document.getElementById('dayModal').style.display = 'flex';
    });
});

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAddModal();
        closeDayModal();
    }
});
</script>
{% endblock %}
