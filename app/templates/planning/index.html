{% extends "base.html" %}

{% block title %}Weekly Plan - Workout Tracker{% endblock %}

{% block content %}
<div class="planning">
    <header class="page-header">
        <h1>Weekly Plan</h1>
        <p class="week-range">{{ week_start.strftime('%b %d') }} - {{ week_end.strftime('%b %d, %Y') }}</p>
    </header>

    <!-- Week Navigation -->
    <div class="week-nav">
        <a href="{{ url_for('planning.index', week=week_offset-1) }}" class="btn btn-secondary btn-sm">&larr; Prev</a>
        {% if week_offset != 0 %}
        <a href="{{ url_for('planning.index') }}" class="btn btn-secondary btn-sm">Today</a>
        {% endif %}
        <a href="{{ url_for('planning.index', week=week_offset+1) }}" class="btn btn-secondary btn-sm">Next &rarr;</a>
    </div>

    <!-- Completion Stats -->
    {% if stats.total > 0 %}
    <div class="completion-stats card">
        <div class="stat-row">
            <span class="stat-label">4-Week Completion</span>
            <span class="stat-value {% if stats.rate >= 80 %}text-success{% elif stats.rate >= 50 %}text-warning{% else %}text-danger{% endif %}">
                {{ stats.rate }}%
            </span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: {{ stats.rate }}%"></div>
        </div>
        <p class="stat-detail">{{ stats.completed }} of {{ stats.total }} planned workouts completed</p>
    </div>
    {% endif %}

    <!-- Quick Templates -->
    <div class="templates-section card">
        <h3>Quick Templates</h3>
        <div class="template-buttons">
            <a href="{{ url_for('planning.apply_template', template_name='nippard_upper') }}"
               class="btn btn-secondary btn-sm"
               onclick="return confirm('This will replace your current week\'s plan. Continue?')">
                Nippard Upper
            </a>
            <a href="{{ url_for('planning.apply_template', template_name='running_focus') }}"
               class="btn btn-secondary btn-sm"
               onclick="return confirm('This will replace your current week\'s plan. Continue?')">
                Running Focus
            </a>
            <a href="{{ url_for('planning.apply_template', template_name='balanced') }}"
               class="btn btn-secondary btn-sm"
               onclick="return confirm('This will replace your current week\'s plan. Continue?')">
                Balanced
            </a>
        </div>
    </div>

    <!-- Weekly Calendar -->
    <div class="week-calendar">
        {% for day in week_days %}
        <div class="day-card {% if day.is_today %}today{% endif %} {% if day.is_past %}past{% endif %}">
            <div class="day-header">
                <span class="day-name">{{ day.day_name[:3] }}</span>
                <span class="day-date">{{ day.date.strftime('%d') }}</span>
            </div>

            <div class="day-content">
                <!-- Planned workouts -->
                {% for plan in day.plans %}
                <div class="planned-item {{ plan.workout_type }} {% if plan.completed %}completed{% endif %}">
                    <span class="plan-icon">
                        {% if plan.workout_type == 'upper_body' %}&#128170;
                        {% elif plan.workout_type == 'running' %}&#127939;
                        {% else %}&#128164;{% endif %}
                    </span>
                    <span class="plan-text">{{ plan.description or plan.workout_type|replace('_', ' ')|title }}</span>
                    {% if plan.completed %}
                    <span class="check-mark">&#10003;</span>
                    {% elif not day.is_past %}
                    <form method="POST" action="{{ url_for('planning.complete_plan', plan_id=plan.plan_id) }}" class="inline-form">
                        <button type="submit" class="btn-icon btn-complete" title="Mark Complete">&#10003;</button>
                    </form>
                    {% endif %}
                    <form method="POST" action="{{ url_for('planning.delete_plan', plan_id=plan.plan_id) }}" class="inline-form">
                        <button type="submit" class="btn-icon btn-delete-small" title="Delete">&times;</button>
                    </form>
                </div>
                {% endfor %}

                <!-- Actual workouts (if no plan for that workout type) -->
                {% for workout in day.actual %}
                {% set has_plan = day.plans|selectattr('workout_type', 'equalto', workout.session_type)|list|length > 0 %}
                {% if not has_plan %}
                <div class="actual-item {{ workout.session_type }}">
                    <span class="plan-icon">
                        {% if workout.session_type == 'upper_body' %}&#128170;
                        {% elif workout.session_type == 'running' %}&#127939;
                        {% else %}&#127947;{% endif %}
                    </span>
                    <span class="plan-text">{{ workout.session_type|replace('_', ' ')|title }}</span>
                    <span class="unplanned-badge">Unplanned</span>
                </div>
                {% endif %}
                {% endfor %}

                <!-- Add button -->
                {% if not day.is_past or day.is_today %}
                <a href="{{ url_for('planning.add_plan', date=day.date.isoformat()) }}" class="add-plan-btn">
                    + Add
                </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Legend -->
    <div class="legend card">
        <h3>Legend</h3>
        <div class="legend-items">
            <div class="legend-item">
                <span class="legend-icon upper_body">&#128170;</span>
                <span>Strength</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon running">&#127939;</span>
                <span>Running</span>
            </div>
            <div class="legend-item">
                <span class="legend-icon rest">&#128164;</span>
                <span>Rest</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}
